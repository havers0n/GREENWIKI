digraph DataFlow {
  rankdir=TB;
  node [shape=box, style=rounded];

  // Внешние входы
  subgraph cluster_inputs {
    label="Входы";
    User [label="Пользователь"];
    API [label="API запросы"];
    Database [label="База данных"];
  }

  // Основной поток
  subgraph cluster_main {
    label="Основной поток";

    // Загрузка страницы
    LoadPage [label="Загрузка страницы\nGET /api/pages"];
    LoadBlocks [label="Загрузка блоков\nGET /api/layout/:page"];
    RenderPage [label="Рендеринг страницы"];

    // Редактирование
    EditMode [label="Режим редактора"];
    BlockLibrary [label="Библиотека блоков"];
    DragDrop [label="Drag & Drop"];
    ContextualInspector [label="Инспектор свойств"];

    // Сохранение
    SaveChanges [label="Сохранение изменений\nPUT /api/layout/*"];
    CreateRevision [label="Создание ревизии\nPOST /api/layout/*/revisions"];

    // Восстановление
    LoadRevision [label="Загрузка ревизии"];
    RevertRevision [label="Откат к ревизии\nPOST /api/layout/*/revisions/*/revert"];
  }

  // Проблемные области
  subgraph cluster_issues {
    label="Проблемные области";
    node [color=red];

    MissingDelete [label="ОТСУТСТВИЕ\nкнопки удаления"];
    NoPageSelector [label="НЕТ селектора\nстраниц"];
    BrokenRevisions [label="РЕВИЗИИ НЕ СОХРАНЯЮТ\nparent_block_id и slot"];
    NoCascadeDelete [label="НЕТ каскадного\nудаления"];
    NoValidation [label="НЕТ валидации\nallowedChildren"];
  }

  // Связи
  User -> LoadPage;
  API -> LoadPage;
  Database -> LoadBlocks;

  LoadPage -> LoadBlocks;
  LoadBlocks -> RenderPage;

  RenderPage -> EditMode [label="редактирование"];
  EditMode -> BlockLibrary;
  EditMode -> DragDrop;
  EditMode -> ContextualInspector;

  BlockLibrary -> SaveChanges;
  DragDrop -> SaveChanges;
  ContextualInspector -> SaveChanges;

  SaveChanges -> CreateRevision;
  SaveChanges -> Database;

  CreateRevision -> Database;
  LoadRevision -> RevertRevision;
  RevertRevision -> Database;

  // Проблемные связи
  EditMode -> MissingDelete [color=red, label="критично"];
  EditMode -> NoPageSelector [color=red, label="критично"];
  CreateRevision -> BrokenRevisions [color=red, label="критично"];
  SaveChanges -> NoCascadeDelete [color=red, label="важно"];
  SaveChanges -> NoValidation [color=red, label="важно"];

  // Легенда
  subgraph cluster_legend {
    label="Легенда";
    Working [label="Работает", color=green];
    Broken [label="Сломано", color=red];
    Missing [label="Отсутствует", color=orange];
  }
}
