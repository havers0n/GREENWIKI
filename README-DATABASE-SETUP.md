# Настройка базы данных для CMS системы

## Проблема

При открытии модального окна "Ревизии" возникает ошибка, поскольку в базе данных отсутствуют необходимые таблицы для работы CMS системы управления контентом.

## Решение

Для корректной работы всех функций CMS необходимо создать следующие таблицы в вашей базе данных Supabase:

- `layout_blocks` - блоки макета страниц с поддержкой вложенности
- `layout_revisions` - ревизии макета для отката изменений  
- `page_templates` - шаблоны страниц для быстрого создания
- `pages` - страницы сайта
- `categories` - категории для организации контента
- `sections` - секции контента

## Инструкция по установке

### Шаг 1: Откройте SQL Editor в Supabase

1. Перейдите в ваш проект Supabase
2. Откройте раздел "SQL Editor" в левом меню
3. Создайте новый запрос

### Шаг 2: Выполните SQL скрипт

1. Скопируйте содержимое файла `database-setup.sql`
2. Вставьте его в SQL Editor
3. Нажмите "Run" для выполнения скрипта

### Шаг 3: Проверьте создание таблиц

После выполнения скрипта проверьте, что все таблицы созданы:

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('layout_blocks', 'layout_revisions', 'page_templates', 'pages', 'categories', 'sections');
```

### Шаг 4: Обновите типы TypeScript

После создания таблиц обновите типы для фронтенда:

```bash
pnpm gen:types
```

## Что включает скрипт

### Таблицы

- **layout_blocks** - основная таблица для блоков с поддержкой:
  - Вложенности через `parent_block_id` и `slot`
  - Позиционирования через `position`
  - Статусов публикации (`draft`/`published`)
  
- **layout_revisions** - система версионирования:
  - Снимки состояния страницы в JSON формате
  - Информация об авторе и времени создания
  
- **page_templates** - шаблоны для быстрого создания:
  - Наборы блоков для типовых страниц
  - Метаданные шаблонов

### Безопасность (RLS)

- Публичный доступ только к опубликованному контенту
- Полный доступ для администраторов
- Защита через Row Level Security (RLS)

### Индексы

- Оптимизация запросов по `page_identifier`
- Индексы для сортировки по позиции
- Индексы для иерархических запросов

## Функции, которые станут доступны

После создания таблиц будут работать:

✅ **Ревизии**
- Создание снимков состояния страницы
- Откат к предыдущим версиям
- История изменений

✅ **Шаблоны**  
- Сохранение текущего макета как шаблон
- Применение готовых шаблонов
- Библиотека шаблонов

✅ **Вложенные блоки**
- Контейнеры с колонками
- Drag & Drop в слоты
- Иерархическая структура

✅ **Система публикации**
- Черновики и опубликованный контент
- Контроль видимости
- Workflow управления контентом

## Устранение неполадок

### Ошибка прав доступа

Если возникает ошибка доступа, убедитесь что:
1. У вас есть права администратора в Supabase
2. В таблице `profiles` у вашего пользователя установлена роль `admin`

### Ошибка внешних ключей

Если возникают ошибки с внешними ключами:
1. Убедитесь что таблица `profiles` существует
2. Проверьте наличие функции `gen_random_uuid()`

### Проверка ролей пользователя

```sql
SELECT id, role FROM public.profiles WHERE id = auth.uid();
```

Если роль не `admin`, обновите её:

```sql
UPDATE public.profiles SET role = 'admin' WHERE id = auth.uid();
```

## Поддержка

После выполнения всех шагов CMS система будет полностью функциональна. Если остались вопросы или возникают ошибки, проверьте:

1. Логи в консоли браузера
2. Логи Supabase в разделе "Logs"  
3. Корректность выполнения SQL скрипта

---

**Важно**: Данный скрипт безопасен для выполнения на существующей базе данных - он использует `IF NOT EXISTS` и `ON CONFLICT` для предотвращения дублирования данных.
