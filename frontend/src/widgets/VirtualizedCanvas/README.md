# VirtualizedCanvas

–í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–ª–æ–∫–æ–≤ –Ω–∞ —Ö–æ–ª—Å—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.

## –û–±–∑–æ—Ä

VirtualizedCanvas –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ –±–ª–æ–∫–∏. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±–ª–æ–∫–æ–≤ (50+).

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üöÄ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ –±–ª–æ–∫–∏
- üìè **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ—Ä—è–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
- üéØ **D&D —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ drag & drop –≤ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
- ‚ö° **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏**: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–æ–≤
- üì± **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö —ç–∫—Ä–∞–Ω–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `index.tsx` - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç VirtualizedCanvas
- `useDynamicVirtualizer.ts` - –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–µ–π

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `@tanstack/react-virtual` - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
- `@dnd-kit/core` - Drag & drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- `react` - React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

## API

```typescript
interface VirtualizedCanvasProps {
  blockTree: BlockNode[];           // –î–µ—Ä–µ–≤–æ –±–ª–æ–∫–æ–≤ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  editorMode?: boolean;             // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  selectedBlockId?: string | null;  // ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
  onSelectBlock?: (id: string | null) => void; // –ö–æ–ª–±—ç–∫ –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
  onUpdateBlock?: (updated: BlockNode) => void; // –ö–æ–ª–±—ç–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
  isCanvasOver?: boolean;           // –§–ª–∞–≥ hover –Ω–∞–¥ –∫–∞–Ω–≤–∞—Å–æ–º
}
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```tsx
import { VirtualizedCanvas } from '../VirtualizedCanvas';

function EditorCanvas({ blockTree, ...props }) {
  return (
    <VirtualizedCanvas
      blockTree={blockTree}
      editorMode={true}
      selectedBlockId={selectedBlockId}
      onSelectBlock={handleSelectBlock}
      onUpdateBlock={handleUpdateBlock}
      isCanvasOver={isCanvasOver}
    />
  );
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:
- ‚è±Ô∏è –í—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∞: ~150-200ms –¥–ª—è 200 –±–ª–æ–∫–æ–≤
- üîÑ –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫: 201 –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ 1 –±–ª–æ–∫–∞
- üíæ –ü–∞–º—è—Ç—å: ~35MB –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

### –ü–æ—Å–ª–µ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:
- ‚è±Ô∏è –í—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∞: <50ms –¥–ª—è 200 –±–ª–æ–∫–æ–≤ (—É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 70%)
- üîÑ –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫: 1-2 –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ 1 –±–ª–æ–∫–∞
- üíæ –ü–∞–º—è—Ç—å: <2MB —Ä–æ—Å—Ç–∞ (—É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 80%)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `@tanstack/react-virtual` –¥–ª—è windowing
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ `getBoundingClientRect()`
- Overscan –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### D&D –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ–Ω—Å–æ—Ä–æ–≤ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Å–∫—Ä–æ–ª–ª-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ drop zones –≤–Ω—É—Ç—Ä–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- `forwardRef` –≤ BlockWrapper –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—Ñ—ã –¥–ª—è D&D –∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
- Data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- CSS containment –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤:
```typescript
// –í useDynamicVirtualizer.ts
console.log(`Block ${blockId} size changed to ${height}px`);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:
```typescript
// –í DevTools Console
const canvas = document.querySelector('[data-testid="virtualized-canvas"]');
console.log('Virtual items:', canvas?.children.length);
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
1. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–ª–æ–∫–æ–≤
2. –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
3. Drag & drop –æ–ø–µ—Ä–∞—Ü–∏–π
4. –í—ã–±–æ—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤
5. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –±–ª–æ–∫–æ–≤

### –ú–µ—Ç—Ä–∏–∫–∏:
- –í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ < 100ms
- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ < 30ms
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
- FPS –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ > 60

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –ê–Ω–∏–º–∞—Ü–∏–∏ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å nested —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏

### Workarounds:
- Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ React DevTools Profiler

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- Windowing –¥–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- Intersection Observer –¥–ª—è lazy loading
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π –≤ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- Web Workers –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `docs/performance/virtualization-implementation.md`
- `docs/performance/baseline.md`

### –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:
- `frontend/src/widgets/VirtualizedCanvas/`

### –ö–æ–Ω—Ç–∞–∫—Ç—ã:
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
